<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HERPLUS ‚Äì Registro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass{background:rgba(255,255,255,.82);backdrop-filter:saturate(140%) blur(10px)}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);padding:.5rem .75rem;border-radius:.5rem;background:#0ea5e9;color:#fff;font-size:.85rem;box-shadow:0 10px 20px rgba(2,132,199,.3);opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}
    .hint{font-size:.72rem}
    button:focus,a:focus{outline:2px solid #6366f1;outline-offset:2px}
    .input-ok{outline:2px solid #10b981}
    .input-bad{outline:2px solid #ef4444}
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-emerald-50 text-slate-800">
  <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-600" aria-hidden="true"></div>
        <div>
          <h1 class="text-lg font-semibold leading-tight">HERPLUS</h1>
          <p class="text-xs text-slate-500">Registro oficina virtual</p>
        </div>
      </div>
      <a href="oficina.html" class="text-xs text-indigo-700 hover:underline">Ir a Oficina Virtual</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <section class="max-w-lg mx-auto glass rounded-2xl p-6 shadow-lg">
      <h2 class="text-xl font-semibold">Crea tu acceso</h2>
      <p class="text-sm text-slate-600">Completa tus datos para activar tu Oficina Virtual.</p>

      <!-- Sponsor -->
      <div class="mt-4 p-3 rounded-xl border bg-slate-50">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-500">Sponsor asignado</div>
            <div id="sponsorUser" class="text-sm font-medium">‚Äî</div>
          </div>
          <span id="sponsorStatus" class="px-2 py-0.5 rounded bg-slate-200 text-xs">Verificando‚Ä¶</span>
        </div>
        <p class="mt-1 text-[11px] text-slate-500">Si no vienes con un enlace de referido, se asignar√° <b>HERPLUS</b> como sponsor.</p>
      </div>

      <!-- FORM -->
      <div class="grid gap-3 mt-5">
        <div>
          <label class="text-xs text-slate-500" for="username">Nombre de usuario</label>
          <div class="relative">
            <input id="username" class="w-full border rounded-lg px-3 py-2 pr-20" placeholder="tu_usuario" autocomplete="username" />
            <span id="userChk" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500">‚Äî</span>
          </div>
          <p class="hint text-slate-500">3‚Äì20 caracteres (letras, n√∫meros y _). Debe ser √∫nico.</p>
        </div>

        <div>
          <label class="text-xs text-slate-500" for="email">Correo electr√≥nico</label>
          <input id="email" type="email" class="w-full border rounded-lg px-3 py-2" placeholder="tu@correo.com" autocomplete="email" />
        </div>

        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-500" for="pass">C√≥digo/Contrase√±a</label>
            <div class="relative">
              <input id="pass" type="password" class="w-full border rounded-lg px-3 py-2 pr-10" placeholder="m√≠n. 6 caracteres" autocomplete="new-password" />
              <button id="toggle1" type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm">üëÅ</button>
            </div>
          </div>
          <div>
            <label class="text-xs text-slate-500" for="pass2">Repite el c√≥digo</label>
            <div class="relative">
              <input id="pass2" type="password" class="w-full border rounded-lg px-3 py-2 pr-10" placeholder="confirmaci√≥n" autocomplete="new-password" />
              <button id="toggle2" type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm">üëÅ</button>
            </div>
          </div>
        </div>

        <div>
          <label class="text-xs text-slate-500" for="whats">WhatsApp (incluye c√≥digo de pa√≠s)</label>
          <input id="whats" class="w-full border rounded-lg px-3 py-2" placeholder="+5049XXXXXXX" autocomplete="tel" />
          <p class="hint text-slate-500">Formato internacional: +c√≥digo y n√∫mero (8‚Äì15 d√≠gitos).</p>
        </div>

        <div class="flex items-start gap-2 mt-1">
          <input id="terms" type="checkbox" class="mt-1">
          <label for="terms" class="text-xs text-slate-600">Acepto los t√©rminos y la pol√≠tica de privacidad.</label>
        </div>

        <button id="submitBtn" type="button" class="mt-2 px-4 py-2 rounded-lg bg-indigo-600 text-white">Crear cuenta</button>
        <p id="formMsg" class="text-xs mt-1" aria-live="polite"></p>

        <div class="mt-4 p-3 rounded-xl border bg-emerald-50 text-emerald-700 text-xs">
          <b>Gracias por registrarte.</b> En breve un asesor de HERPLUS se comunicar√° contigo v√≠a WhatsApp para completar la activaci√≥n y validar tus datos.
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" aria-live="polite">Procesando‚Ä¶</div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyD_v8yXx1W6zcGFXXMHeNJh0RSzbnO-j84",
      authDomain: "herplus.firebaseapp.com",
      projectId: "herplus",
      storageBucket: "herplus.appspot.com",
      messagingSenderId: "556494279952",
      appId: "1:556494279952:web:f788776f50840b28434195"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ===== Config locales =====
    const OFFICE_URL = new URL("oficina.html", window.location.href).href; // Redirige a Oficina al terminar

    // ‚úÖ UID/Username corporativo por defecto (mismo valor simb√≥lico usado en el panel)
    const ADMIN_UID_DEFAULT = "HERPLUS";
    const ADMIN_USERNAME_DEFAULT = "HERPLUS";

    // ===== Utils =====
    const $ = (id)=>document.getElementById(id);
    function toast(msg="Listo"){ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1500); }
    function setMsg(el, msg, ok=false){ el.textContent = msg; el.className = "text-xs mt-1 " + (ok ? "text-emerald-600" : "text-rose-600"); }
    function getParam(name){ return new URLSearchParams(location.search).get(name) || ""; }
    const reUser = /^[a-zA-Z0-9_]{3,20}$/;
    const rePhoneIntl = /^\+\d{8,15}$/;
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((v||"").trim()); }
    function norm(v){ return (v||"").trim(); }
    function addOk(el){ el.classList.remove("input-bad"); el.classList.add("input-ok"); }
    function addBad(el){ el.classList.remove("input-ok"); el.classList.add("input-bad"); }
    function clearMark(el){ el.classList.remove("input-ok","input-bad"); }

    async function usernameDisponible(u){
      const qs = await db.collection("users").where("username","==",u).limit(1).get();
      return qs.empty;
    }
    async function getUserDocById(id){
      const s = await db.collection("users").doc(id).get();
      if(!s.exists) return null;
      const d = s.data() || {};
      return { id, username: d.username || id, exists: true };
    }
    async function getUserDocByUsername(username){
      const qs = await db.collection("users").where("username","==",username).limit(1).get();
      if(qs.empty) return null;
      const doc = qs.docs[0]; const d = doc.data() || {};
      return { id: doc.id, username: d.username || doc.id, exists: true };
    }
    function looksLikeUid(s){ return /^[A-Za-z0-9._-]{16,40}$/.test(s||""); }

    // ===== Resolver sponsor (?ref=UID o ?ref=@usuario). Si no, HERPLUS. =====
    const sponsor = { id:null, username:null, exists:false };
    (async function initSponsor(){
      const tag = $("sponsorStatus"), name = $("sponsorUser");
      const ref = getParam("ref")?.replace(/^@/,"");

      if(ref){
        try{
          let got = looksLikeUid(ref) ? await getUserDocById(ref) : await getUserDocByUsername(ref);
          if(!got){ got = looksLikeUid(ref) ? await getUserDocByUsername(ref) : await getUserDocById(ref); }
          if(got){
            Object.assign(sponsor, got, { exists:true });
            tag.textContent = "Verificado";
            tag.className = "px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 text-xs";
            name.textContent = "@"+sponsor.username;
            return;
          }
        }catch(_){}
      }
      // Fallback fijo ‚Üí HERPLUS (corporativo)
      sponsor.id = ADMIN_UID_DEFAULT;
      sponsor.username = ADMIN_USERNAME_DEFAULT || ADMIN_UID_DEFAULT;
      sponsor.exists = true;
      tag.textContent = "Asignado";
      tag.className = "px-2 py-0.5 rounded bg-indigo-100 text-indigo-700 text-xs";
      name.textContent = "@"+sponsor.username + " (corporativo)";
    })();

    // ===== UI: mostrar/ocultar contrase√±as =====
    function togglePwd(btnId, inputId){
      $(btnId).addEventListener("click", ()=>{
        const i=$(inputId); i.type = i.type==="password" ? "text" : "password"; i.focus();
      });
    }
    togglePwd("toggle1","pass");
    togglePwd("toggle2","pass2");

    // ===== Chequeo en vivo de username =====
    let userTimer=null, lastChecked="";
    $("username").addEventListener("input", ()=>{
      const i = $("username"); const badge = $("userChk");
      clearMark(i); badge.textContent = "‚Ä¶";
      const v = norm(i.value);
      if(!reUser.test(v)){ badge.textContent = "inv√°lido"; addBad(i); return; }
      if(userTimer) clearTimeout(userTimer);
      userTimer = setTimeout(async ()=>{
        if(v===lastChecked) return;
        lastChecked = v;
        try{
          const ok = await usernameDisponible(v);
          if(ok){ badge.textContent = "disponible"; addOk(i); }
          else  { badge.textContent = "ocupado"; addBad(i); }
        }catch{ badge.textContent = "error"; addBad(i); }
      }, 350);
    });

    // Enter para enviar
    ["username","email","pass","pass2","whats"].forEach(id=>{
      $(id).addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("submitBtn").click(); });
    });

    // ===== Registro =====
    $("submitBtn").addEventListener("click", async ()=>{
      const msg = $("formMsg"); setMsg(msg, "");

      const username = norm($("username").value);
      const email = norm($("email").value);
      const pass = $("pass").value;
      const pass2 = $("pass2").value;
      const whats = norm($("whats").value);
      const terms = $("terms").checked;

      // Validaciones
      if(!reUser.test(username)) return setMsg(msg,"Usuario inv√°lido. Usa 3‚Äì20 caracteres (letras, n√∫meros, _).");
      if(!email || !validEmail(email)) return setMsg(msg,"Correo inv√°lido.");
      if(!pass || pass.length<6) return setMsg(msg,"La contrase√±a debe tener al menos 6 caracteres.");
      if(pass !== pass2) return setMsg(msg,"Las contrase√±as no coinciden.");
      if(!rePhoneIntl.test(whats)) return setMsg(msg,"WhatsApp inv√°lido. Usa formato +c√≥digo y n√∫mero (8‚Äì15 d√≠gitos).");
      if(!terms) return setMsg(msg,"Debes aceptar los t√©rminos para continuar.");

      try{
        toast("Validando usuario‚Ä¶");
        const libre = await usernameDisponible(username);
        if(!libre) return setMsg(msg,"Ese usuario ya existe. Prueba otro.");

        toast("Creando cuenta‚Ä¶");
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        const uid = cred.user.uid;
        try{ await cred.user.updateProfile({ displayName: username }); }catch(_){}

        // Sponsor definitivo (HERPLUS por defecto)
        const sponsorId = sponsor?.id || ADMIN_UID_DEFAULT;
        const sponsorUsername = sponsor?.username || ADMIN_USERNAME_DEFAULT || null;

        // Documento principal del usuario
        const now = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection("users").doc(uid).set({
          uid,
          username,
          email,
          whatsapp: whats,
          sponsorId,
          sponsorUsername,
          placementParentId: sponsorId,
          depth: 0,
          status: "pending",
          createdAt: now,
          updatedAt: now,
          rank: { level:0, name:"Sin rango", badge:"‚¨ú", updatedAt: now }
        }, { merge: true });

        // Wallet opcional en 0 (si no existe)
        await db.collection("wallets").doc(uid).set({ balance: 0 }, { merge: true });

        setMsg(msg, "Registro completado. Redirigiendo a tu Oficina‚Ä¶", true);
        toast("¬°Bienvenido a HERPLUS!");
        setTimeout(()=>{ location.href = OFFICE_URL; }, 900);
      }catch(e){
        console.error(e);
        const code = e?.code || "";
        if(code==="auth/email-already-in-use") return setMsg(msg,"Ese correo ya est√° en uso.");
        if(code==="auth/invalid-email") return setMsg(msg,"Correo inv√°lido.");
        if(code==="auth/weak-password") return setMsg(msg,"La contrase√±a es muy d√©bil (m√≠nimo 6).");
        setMsg(msg, e?.message || "No se pudo crear la cuenta.");
      }
    });
  </script>
</body>
</html>












